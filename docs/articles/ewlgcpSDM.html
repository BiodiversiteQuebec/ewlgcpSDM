<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>ewlgcpSDM • ewlgcpSDM</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="ewlgcpSDM">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">ewlgcpSDM</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.1000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/ewlgcpSDM.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>ewlgcpSDM</h1>
            
      

      <div class="d-none name"><code>ewlgcpSDM.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction-to-ewlgcpsdm">Introduction to ewlgcpSDM<a class="anchor" aria-label="anchor" href="#introduction-to-ewlgcpsdm"></a>
</h2>
<p><strong>ewlgcpSDM</strong> is a package for inferring species
distributions from presence-only data using effort-weighted Log-Gaussian
Cox point process models.</p>
<p>First, let’s install some useful packages.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/rgbif" class="external-link">rgbif</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/" class="external-link">terra</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">geodata</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ateucher/rmapshaper" class="external-link">rmapshaper</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">INLA</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/rnaturalearth/" class="external-link">rnaturalearth</a></span><span class="op">)</span></span>
<span><span class="co"># devtools::load_all('.')</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://biodiversitequebec.github.io/ewlgcpSDM/">ewlgcpSDM</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="define-study-area">Define study area<a class="anchor" aria-label="anchor" href="#define-study-area"></a>
</h3>
<p>We will first download some polygons to define the study area and to
help with the mapping later.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Downloads polygons using package geodata</span></span>
<span><span class="va">can</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/geodata/man/gadm.html" class="external-link">gadm</a></span><span class="op">(</span><span class="st">"CAN"</span>, level <span class="op">=</span> <span class="fl">1</span>, path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/getwd.html" class="external-link">getwd</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">usa</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/geodata/man/gadm.html" class="external-link">gadm</a></span><span class="op">(</span><span class="st">"USA"</span>, level <span class="op">=</span> <span class="fl">1</span>, path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/getwd.html" class="external-link">getwd</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">na</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">can</span>, <span class="va">usa</span><span class="op">)</span></span>
<span><span class="va">na</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="va">na</span>, <span class="fl">32618</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># keep Québec and bordering provinces/states as a buffer</span></span>
<span><span class="va">region</span> <span class="op">&lt;-</span> <span class="va">na</span><span class="op">[</span><span class="va">na</span><span class="op">$</span><span class="va">NAME_1</span> <span class="op"><a href="https://rspatial.github.io/terra/reference/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Québec"</span>, <span class="st">"New Brunswick"</span>, <span class="st">"Maine"</span>, <span class="st">"Vermont"</span>,</span>
<span>    <span class="st">"New Hampshire"</span>, <span class="st">"New York"</span>, <span class="st">"Ontario"</span><span class="op">)</span>, <span class="op">]</span></span>
<span></span>
<span><span class="co"># split NF into different polygons</span></span>
<span><span class="va">labrador</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rmapshaper/man/ms_explode.html" class="external-link">ms_explode</a></span><span class="op">(</span><span class="va">na</span><span class="op">[</span><span class="va">na</span><span class="op">$</span><span class="va">NAME_1</span> <span class="op"><a href="https://rspatial.github.io/terra/reference/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Newfoundland and Labrador"</span><span class="op">)</span>,</span>
<span>    <span class="op">]</span><span class="op">)</span></span>
<span><span class="va">labrador</span> <span class="op">&lt;-</span> <span class="va">labrador</span><span class="op">[</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/summarize-generics.html" class="external-link">which.max</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_measures.html" class="external-link">st_area</a></span><span class="op">(</span><span class="va">labrador</span><span class="op">)</span><span class="op">)</span>, <span class="op">]</span>  <span class="co"># keep Labarador</span></span>
<span><span class="va">region</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">region</span>, <span class="va">labrador</span><span class="op">)</span></span>
<span><span class="va">qc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rmapshaper/man/ms_simplify.html" class="external-link">ms_simplify</a></span><span class="op">(</span><span class="va">region</span>, <span class="fl">0.01</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add it to the study region</span></span>
<span><span class="va">region</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">region</span>, <span class="va">labrador</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Simplify polygons to make things faster</span></span>
<span><span class="va">region</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rmapshaper/man/ms_simplify.html" class="external-link">ms_simplify</a></span><span class="op">(</span><span class="va">region</span>, <span class="fl">0.005</span><span class="op">)</span></span>
<span><span class="va">region</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_combine.html" class="external-link">st_union</a></span><span class="op">(</span><span class="va">region</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># lakes</span></span>
<span><span class="va">lakes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://docs.ropensci.org/rnaturalearth/reference/ne_download.html" class="external-link">ne_download</a></span><span class="op">(</span>scale <span class="op">=</span> <span class="st">"medium"</span>, type <span class="op">=</span> <span class="st">"lakes"</span>, destdir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/getwd.html" class="external-link">getwd</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    category <span class="op">=</span> <span class="st">"physical"</span>, returnclass <span class="op">=</span> <span class="st">"sf"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="fl">32618</span><span class="op">)</span></span>
<span><span class="co">#&gt; Reading layer `ne_50m_lakes' from data source </span></span>
<span><span class="co">#&gt;   `/home/frousseu/Documents/github/ewlgcpSDM/vignettes/ne_50m_lakes.shp' </span></span>
<span><span class="co">#&gt;   using driver `ESRI Shapefile'</span></span>
<span><span class="co">#&gt; Simple feature collection with 412 features and 39 fields</span></span>
<span><span class="co">#&gt; Geometry type: POLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: -165.8985 ymin: -50.62002 xmax: 176.0827 ymax: 81.94033</span></span>
<span><span class="co">#&gt; Geodetic CRS:  WGS 84</span></span>
<span><span class="va">lakes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_join.html" class="external-link">st_filter</a></span><span class="op">(</span><span class="va">lakes</span>, <span class="va">region</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">plotQC</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># plotting function for the study area</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">qc</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"lemonchiffon2"</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">region</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">lakes</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"white"</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu">plotQC</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="ewlgcpSDM_files/figure-html/unnamed-chunk-2-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="get-observations">Get observations<a class="anchor" aria-label="anchor" href="#get-observations"></a>
</h3>
<p>We will get observations form GBIF, but first we will provide a
polygon in the WKT format to restrict observations to the study area. We
first need to simplify the polygon for the GBIF API to accept it
(<code>wkt</code> &lt; 1500 characters, unless <code>geom_big</code> is
specified).</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">wkt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_combine.html" class="external-link">st_union</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_buffer</a></span><span class="op">(</span><span class="va">region</span>, <span class="fl">20000</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">wkt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rmapshaper/man/ms_simplify.html" class="external-link">ms_simplify</a></span><span class="op">(</span><span class="va">wkt</span>, <span class="fl">0.005</span><span class="op">)</span></span>
<span><span class="va">wkt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="va">wkt</span>, <span class="fl">4326</span><span class="op">)</span></span>
<span><span class="va">wkt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_text.html" class="external-link">st_as_text</a></span><span class="op">(</span><span class="va">wkt</span><span class="op">)</span></span>
<span></span>
<span><span class="va">obs</span> <span class="op">&lt;-</span> <span class="fu">rgbif</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/rgbif/reference/occ_data.html" class="external-link">occ_data</a></span><span class="op">(</span>scientificName <span class="op">=</span> <span class="st">"Picea mariana"</span>, hasCoordinate <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    limit <span class="op">=</span> <span class="fl">10000</span>, geometry <span class="op">=</span> <span class="va">wkt</span><span class="op">)</span><span class="op">$</span><span class="va">data</span></span>
<span><span class="va">rem</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">obs</span><span class="op">$</span><span class="va">coordinateUncertaintyInMeters</span> <span class="op">&gt;</span> <span class="fl">30000</span><span class="op">)</span>  <span class="co"># removes locations with high uncertainty</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="va">rem</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">obs</span> <span class="op">&lt;-</span> <span class="va">obs</span><span class="op">[</span><span class="op">-</span><span class="va">rem</span>, <span class="op">]</span></span>
<span><span class="op">}</span></span>
<span><span class="va">obs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">obs</span><span class="op">)</span>, coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"decimalLongitude"</span>, <span class="st">"decimalLatitude"</span><span class="op">)</span>,</span>
<span>    crs <span class="op">=</span> <span class="fl">4326</span><span class="op">)</span></span>
<span><span class="va">obs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="va">obs</span>, <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_crs</a></span><span class="op">(</span><span class="va">region</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">plotQC</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">obs</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="ewlgcpSDM_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
<div class="section level4">
<h4 id="filter-observations">Filter observations<a class="anchor" aria-label="anchor" href="#filter-observations"></a>
</h4>
<p>To reduce observer effects, we will filter out multiple observations
of the species from a single observer in a given location. For this, we
will keep a single observation for each observer/cell over a 5 x 5 km
grid.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">### remove observer/spatial duplicates keeps a single obs per</span></span>
<span><span class="co">### observer/cell</span></span>
<span><span class="va">bb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html" class="external-link">st_bbox</a></span><span class="op">(</span><span class="va">region</span><span class="op">)</span></span>
<span><span class="va">fg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/ext.html" class="external-link">ext</a></span><span class="op">(</span><span class="va">bb</span><span class="op">)</span>, resolution <span class="op">=</span> <span class="fl">5000</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/values.html" class="external-link">values</a></span><span class="op">(</span><span class="va">fg</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">ncell</a></span><span class="op">(</span><span class="va">fg</span><span class="op">)</span></span>
<span><span class="va">e</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fg</span>, <span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="va">obs</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">dups</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/duplicated.html" class="external-link">duplicated</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>cell <span class="op">=</span> <span class="va">e</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span>, observer <span class="op">=</span> <span class="va">obs</span><span class="op">$</span><span class="va">recordedBy</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">dups</span><span class="op">)</span></span>
<span><span class="co">#&gt; dups</span></span>
<span><span class="co">#&gt; FALSE  TRUE </span></span>
<span><span class="co">#&gt;  2321   525</span></span>
<span><span class="va">obs</span> <span class="op">&lt;-</span> <span class="va">obs</span><span class="op">[</span><span class="op">!</span><span class="va">dups</span>, <span class="op">]</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="estimate-effort-surface">Estimate effort surface<a class="anchor" aria-label="anchor" href="#estimate-effort-surface"></a>
</h4>
<p>The density of observations will be used as a background to
approximate an effort surface. We will use a density raster made of the
numbers of observations of plant species within 1 x 1 km cells for all
GBIF observations. This raster is hosted by Biodiversite Québec.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gbif</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="st">"https://object-arbutus.cloud.computecanada.ca/bq-io/io/gbif_heatmaps/gbif_plants_density_06-2022.tif"</span><span class="op">)</span></span>
<span><span class="va">gbif</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/crop.html" class="external-link">crop</a></span><span class="op">(</span><span class="va">gbif</span>, <span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_buffer</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="va">region</span>, <span class="fl">4326</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">gbif</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/mask.html" class="external-link">mask</a></span><span class="op">(</span><span class="va">gbif</span>, <span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_buffer</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="va">region</span>, <span class="fl">4326</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">gbif</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/subst.html" class="external-link">subst</a></span><span class="op">(</span><span class="va">gbif</span>, <span class="cn">NA</span>, <span class="fl">0</span><span class="op">)</span>  <span class="co"># replace NAs with 0</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/aggregate.html" class="external-link">aggregate</a></span><span class="op">(</span><span class="va">gbif</span>, <span class="fl">10</span>, fun <span class="op">=</span> <span class="va">sum</span><span class="op">)</span><span class="op">)</span>, axes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="va">region</span>, <span class="fl">4326</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="ewlgcpSDM_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<p>For convenience, instead of directly using the raster, we will
simulate an observation dataset using the raster as a density
surface.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">### Simulate effort surface/background obs from gbif density raster</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/sample.html" class="external-link">spatSample</a></span><span class="op">(</span><span class="va">gbif</span>, <span class="fl">50000</span>, as.points <span class="op">=</span> <span class="cn">TRUE</span>, method <span class="op">=</span> <span class="st">"weights"</span><span class="op">)</span></span>
<span><span class="va">tb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_crs</a></span><span class="op">(</span><span class="va">region</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">tb</span> <span class="op">&lt;-</span> <span class="va">tb</span><span class="op">[</span>, <span class="st">"geometry"</span><span class="op">]</span></span></code></pre></div>
<p>Finally, we bind the observations and the simulated observations to
obtain the background used as an effort surface.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">obs</span><span class="op">[</span>, <span class="st">"geometry"</span><span class="op">]</span>, <span class="va">tb</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="get-predictors">Get predictors<a class="anchor" aria-label="anchor" href="#get-predictors"></a>
</h3>
<p>Predictors will be taken from the BON in a Box stac-catalogue. We
will first download a subset of predictors and then project them to a
common raster with a 2 x 2 km resolution. See <a href="https://io.biodiversite-quebec.ca/stac/" class="external-link">https://io.biodiversite-quebec.ca/stac/</a>
for a list of possibilities.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">deciduous</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/crop.html" class="external-link">crop</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="st">"https://object-arbutus.cloud.computecanada.ca/bq-io/io/earthenv/landcover/consensus_full_class_3.tif"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="va">region</span>, <span class="fl">4326</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">crops</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/crop.html" class="external-link">crop</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="st">"https://object-arbutus.cloud.computecanada.ca/bq-io/io/earthenv/landcover/consensus_full_class_7.tif"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="va">region</span>, <span class="fl">4326</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">maxtemp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/crop.html" class="external-link">crop</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="st">"https://object-arbutus.cloud.computecanada.ca/bq-io/io/CHELSA/climatologies/CHELSA_bio5_1981-2010_V.2.1.tif"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="va">region</span>, <span class="fl">4326</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html" class="external-link">st_bbox</a></span><span class="op">(</span><span class="va">region</span><span class="op">)</span></span>
<span><span class="va">predictors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/ext.html" class="external-link">ext</a></span><span class="op">(</span><span class="va">bb</span><span class="op">)</span>, resolution <span class="op">=</span> <span class="fl">2000</span>, crs <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/crs.html" class="external-link">crs</a></span><span class="op">(</span><span class="va">region</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">deciduous</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/project.html" class="external-link">project</a></span><span class="op">(</span><span class="va">deciduous</span>, <span class="va">predictors</span><span class="op">)</span></span>
<span><span class="va">crops</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/project.html" class="external-link">project</a></span><span class="op">(</span><span class="va">crops</span>, <span class="va">predictors</span><span class="op">)</span></span>
<span><span class="va">maxtemp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/project.html" class="external-link">project</a></span><span class="op">(</span><span class="va">maxtemp</span>, <span class="va">predictors</span><span class="op">)</span></span>
<span></span>
<span><span class="va">predictors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">deciduous</span>, <span class="va">crops</span>, <span class="va">maxtemp</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">predictors</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"deciduous"</span>, <span class="st">"crops"</span>, <span class="st">"maxtemp"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="prepare-for-modeling">Prepare for modeling<a class="anchor" aria-label="anchor" href="#prepare-for-modeling"></a>
</h3>
<div class="section level4">
<h4 id="build-mesh">Build mesh<a class="anchor" aria-label="anchor" href="#build-mesh"></a>
</h4>
<p>First, we delineate a non-convex hull around the study area that we
will use to create an INLA mesh.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">domain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_sample.html" class="external-link">st_sample</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_buffer</a></span><span class="op">(</span><span class="va">region</span>, <span class="fl">5000</span><span class="op">)</span>, <span class="fl">5000</span><span class="op">)</span></span>
<span><span class="va">domain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.nonconvex.hull.html" class="external-link">inla.nonconvex.hull</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html" class="external-link">st_coordinates</a></span><span class="op">(</span><span class="va">domain</span><span class="op">)</span>, convex <span class="op">=</span> <span class="op">-</span><span class="fl">0.015</span>,</span>
<span>    resolution <span class="op">=</span> <span class="fl">75</span><span class="op">)</span></span></code></pre></div>
<p>We then create the INLA mesh over the study area. We use a coarse
resolution for the mesh edges corresponding to approximately 1% of the
study area diameter and a relatively large outer area for reducing edge
effects. See <a href="">virgilio</a> for advices on creating a good
mesh.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pedge</span><span class="op">&lt;-</span><span class="fl">0.005</span></span>
<span><span class="va">edge</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/diff.html" class="external-link">diff</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html" class="external-link">st_bbox</a></span><span class="op">(</span><span class="va">region</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">*</span><span class="va">pedge</span>,<span class="fu"><a href="https://rspatial.github.io/terra/reference/diff.html" class="external-link">diff</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html" class="external-link">st_bbox</a></span><span class="op">(</span><span class="va">region</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">4</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">*</span><span class="va">pedge</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">edge</span></span>
<span><span class="co">#&gt; [1] 12904.38</span></span>
<span></span>
<span><span class="va">mesh</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.mesh.2d.html" class="external-link">inla.mesh.2d</a></span><span class="op">(</span>loc.domain <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                     max.edge <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">edge</span>,<span class="va">edge</span><span class="op">*</span><span class="fl">3</span><span class="op">)</span>,</span>
<span>                     min.angle <span class="op">=</span> <span class="fl">21</span>,</span>
<span>                     cutoff <span class="op">=</span> <span class="va">edge</span><span class="op">/</span><span class="fl">1</span>,</span>
<span>                     offset <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">edge</span>,<span class="va">edge</span><span class="op">*</span><span class="fl">3</span><span class="op">)</span>,</span>
<span>                     boundary <span class="op">=</span> <span class="va">domain</span>,<span class="co">#inla.mesh.segment(domainloc),</span></span>
<span>                     crs <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_crs</a></span><span class="op">(</span><span class="va">region</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="create-dual-mesh">Create dual mesh<a class="anchor" aria-label="anchor" href="#create-dual-mesh"></a>
</h4>
<p>From an INLA mesh, we create a dual mesh. We will add each subsequent
element to the <code>params</code> object which is a list of objects
required for modeling.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># plan(multicore,workers=3)</span></span>
<span><span class="va">params</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dmesh_mesh.html">dmesh_mesh</a></span><span class="op">(</span><span class="va">mesh</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="compute-weights">Compute weights<a class="anchor" aria-label="anchor" href="#compute-weights"></a>
</h4>
<p>This will compute the weight for each cell of the dual mesh (related
to area).</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">params</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dmesh_weights.html">dmesh_weights</a></span><span class="op">(</span><span class="va">params</span>, <span class="va">region</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="summarize-predictors">Summarize predictors<a class="anchor" aria-label="anchor" href="#summarize-predictors"></a>
</h4>
<p>Next, we will summarize the predictors for each cell of the dual
mesh. The values will also be scaled for modeling.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">params</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dmesh_predictors.html">dmesh_predictors</a></span><span class="op">(</span><span class="va">params</span>, <span class="va">predictors</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dm</span> <span class="op">&lt;-</span> <span class="va">params</span><span class="op">$</span><span class="va">dmesh</span></span>
<span><span class="va">dm</span><span class="op">$</span><span class="va">deciduous</span> <span class="op">&lt;-</span> <span class="va">params</span><span class="op">$</span><span class="va">predictors</span><span class="op">$</span><span class="va">deciduous</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">dm</span><span class="op">[</span>, <span class="st">"deciduous"</span><span class="op">]</span>, border <span class="op">=</span> <span class="cn">NA</span>, nbreaks <span class="op">=</span> <span class="fl">100</span>, pal <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rspatial.github.io/terra/reference/flip.html" class="external-link">rev</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">terrain.colors</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span>, reset <span class="op">=</span> <span class="cn">FALSE</span>, key.pos <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">qc</span><span class="op">)</span>, border <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/adjustcolor.html" class="external-link">adjustcolor</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="fl">0.25</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">lakes</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"white"</span>, border <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/adjustcolor.html" class="external-link">adjustcolor</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="fl">0.25</span><span class="op">)</span>,</span>
<span>    add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="ewlgcpSDM_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
</div>
<div class="section level4">
<h4 id="summarize-observations-and-effort">Summarize observations and effort<a class="anchor" aria-label="anchor" href="#summarize-observations-and-effort"></a>
</h4>
<p>Before summarizing observations, we will first create a 500 km buffer
around locations outside of which we will add a fictious effort
suggesting that the species was not found. This is to avoid predicting
high relative abundances in areas where the species is not found. This
buffer is optional and these values are arbitrary and can be adapted to
specific situations.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">buff</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_buffer</a></span><span class="op">(</span><span class="va">obs</span>, <span class="fl">250000</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_combine.html" class="external-link">st_union</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">plotQC</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">buff</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">obs</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="ewlgcpSDM_files/figure-html/unnamed-chunk-14-1.png" width="700"></p>
<p>We can then sum for each cell of the dual mesh observations of the
species and of the background.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">params</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dmesh_effort.html">dmesh_effort</a></span><span class="op">(</span><span class="va">params</span>, obs <span class="op">=</span> <span class="va">obs</span>, background <span class="op">=</span> <span class="va">bg</span>, buffer <span class="op">=</span> <span class="va">buff</span>,</span>
<span>    adjust <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># w &lt;- which((params$effort$nobs == params$effort$nbackground) &amp;</span></span>
<span><span class="co"># (params$effort$nobs &gt; 0)) params$effort[w, 2:3] &lt;- params$effort[w,</span></span>
<span><span class="co"># 2:3] * 500 hist(params$effort$nobs / params$effort$nbackground,</span></span>
<span><span class="co"># breaks = 50)</span></span>
<span></span>
<span><span class="co"># w &lt;- which(params$weights == 0) params$effort[w, ] &lt;- 0</span></span>
<span></span>
<span><span class="co"># w &lt;- which(params$effort$nbackground &gt; 0) params$effort[w, 2:3] &lt;-</span></span>
<span><span class="co"># params$effort[w, 1]</span></span>
<span></span>
<span><span class="co"># plot(sdm$mean) plot(st_geometry(params$dmesh),add=T)</span></span>
<span><span class="co"># text(st_coordinates(st_centroid(params$dmesh)), label =</span></span>
<span><span class="co"># 1:nrow(params$dmesh), cex = 0.5)</span></span>
<span></span>
<span><span class="co"># params$effort[c(30, 139),]</span></span>
<span></span>
<span><span class="co"># source('https://raw.githubusercontent.com/frousseu/FRutils/refs/heads/master/R/colo.scale.R')</span></span>
<span><span class="co"># par(mar=c(0,0,0,0)) plot(st_geometry(params$dmesh), col =</span></span>
<span><span class="co"># colo.scale(params$effort$nobs / params$effort$nbackground,</span></span>
<span><span class="co"># c('gold', 'forestgreen'))) plot(st_geometry(params$dmesh), col =</span></span>
<span><span class="co"># colo.scale(ifelse(params$weights &gt; 0, params$weights, NA),</span></span>
<span><span class="co"># c('gold', 'forestgreen'))) plot(st_geometry(region), add = TRUE)</span></span>
<span></span>
<span></span>
<span><span class="co"># plot(st_geometry(region), add = TRUE)</span></span>
<span><span class="co"># plot(st_geometry(params$dmesh), add = TRUE)</span></span>
<span></span>
<span><span class="co"># mapview(region) + mapview(params$dmesh)</span></span>
<span></span>
<span><span class="co"># plot(sdm$mean) plot(st_geometry(region), border = 'red', lwd = 1,</span></span>
<span><span class="co"># add = T) plot(st_geometry(params$dmeshcuts), border = 'red', add =</span></span>
<span><span class="co"># T) plot(mesh, add = T)</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="run-model">Run model<a class="anchor" aria-label="anchor" href="#run-model"></a>
</h3>
<p>The model can now be ran. Here, we will fix the standard deviation of
the spatial effect to a very low value which is equivalent to removing
the spatial component from the model. The model becomes a simple
inhomogeneous point process weighted for effort.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/ewlgcp.html">ewlgcp</a></span><span class="op">(</span></span>
<span>  formula<span class="op">=</span><span class="va">y</span><span class="op">~</span><span class="va">deciduous</span><span class="op">+</span><span class="va">deciduous2</span><span class="op">+</span><span class="va">crops</span><span class="op">+</span><span class="va">crops2</span><span class="op">+</span><span class="va">maxtemp</span><span class="op">+</span><span class="va">maxtemp2</span>,</span>
<span>  dmesh<span class="op">=</span><span class="va">params</span>,</span>
<span>  effort <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  adjust <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  buffer <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  orthogonal <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  prior.beta <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  prior.range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5000</span>, <span class="fl">0.01</span><span class="op">)</span>,</span>
<span>  prior.sigma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.00001</span>, <span class="cn">NA</span><span class="op">)</span>,</span>
<span>  smooth <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  num.threads<span class="op">=</span><span class="fl">2</span><span class="op">:</span><span class="fl">2</span>,</span>
<span>  <span class="co">#blas.num.threads=2,</span></span>
<span>  control.inla<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    strategy<span class="op">=</span><span class="st">"adaptive"</span>, <span class="co"># "adaptive"</span></span>
<span>    int.strategy<span class="op">=</span><span class="st">"eb"</span>, <span class="co"># "eb"</span></span>
<span>    huge<span class="op">=</span><span class="cn">FALSE</span>, <span class="co"># apparently ignored</span></span>
<span>    control.vb<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      enable<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>      verbose<span class="op">=</span><span class="cn">TRUE</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span>,<span class="co"># adaptive, eb</span></span>
<span>  inla.mode<span class="op">=</span><span class="st">"experimental"</span>,</span>
<span>  control.compute<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>config<span class="op">=</span><span class="cn">TRUE</span>,openmp.strategy<span class="op">=</span><span class="st">"pardiso"</span><span class="op">)</span>,</span>
<span>  verbose<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>  safe<span class="op">=</span><span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="map-results">Map results<a class="anchor" aria-label="anchor" href="#map-results"></a>
</h3>
<p>The <code>map</code> function will produce an intensity raster along
with the different uncertainty measures and the spatial component.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sdm</span> <span class="op">&lt;-</span> <span class="fu">ewlgcpSDM</span><span class="fu">::</span><span class="fu"><a href="../reference/map.html">map</a></span><span class="op">(</span>model <span class="op">=</span> <span class="va">m</span>, dmesh <span class="op">=</span> <span class="va">params</span>, dims <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1500</span>, <span class="fl">1500</span><span class="op">)</span>,</span>
<span>    region <span class="op">=</span> <span class="va">region</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in fm_crs_bounds(crs, warn.unknown = TRUE): Could not determine shape</span></span>
<span><span class="co">#&gt; of transformation bounds. Using infinite rectangle.</span></span>
<span></span>
<span><span class="va">sdm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/mask.html" class="external-link">mask</a></span><span class="op">(</span><span class="va">sdm</span>, <span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="va">region</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crs.html" class="external-link">crs</a></span><span class="op">(</span><span class="va">sdm</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/crs.html" class="external-link">crs</a></span><span class="op">(</span><span class="va">region</span><span class="op">)</span></span></code></pre></div>
<p>We can finally map the intensity (sdm) along with the uncertainty on
the link scale.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">add_shp</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">qc</span><span class="op">)</span>, border <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/adjustcolor.html" class="external-link">adjustcolor</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="fl">0.25</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">lakes</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"white"</span>, border <span class="op">=</span> <span class="cn">NA</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">obs</span><span class="op">)</span>, cex <span class="op">=</span> <span class="fl">0.1</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">plg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0.5</span><span class="op">)</span>, cex <span class="op">=</span> <span class="fl">0.75</span>, adj <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>, mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">sdm</span><span class="op">$</span><span class="va">mean</span>, main <span class="op">=</span> <span class="st">"Intensity"</span>, axes <span class="op">=</span> <span class="cn">F</span>, plg <span class="op">=</span> <span class="va">plg</span>, mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>,</span>
<span>    <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">add_shp</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">sdm</span><span class="op">$</span><span class="va">linksd</span>, main <span class="op">=</span> <span class="st">"SD on the link scale"</span>, axes <span class="op">=</span> <span class="cn">F</span>, plg <span class="op">=</span> <span class="va">plg</span>, mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,</span>
<span>    <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">add_shp</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="ewlgcpSDM_files/figure-html/unnamed-chunk-18-1.png" width="700"></p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>, mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">4</span>, <span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># plot(exp(sdm$linkmean-sdm$spacemean))</span></span>
<span><span class="co"># plot(mask(exp(sdm$linkmean-sdm$spacemean), vect(region)))</span></span>
<span><span class="co"># plot(sdm$spacemean) plot(sdm$mean)</span></span>
<span></span>
<span><span class="co"># source('https://raw.githubusercontent.com/frousseu/FRutils/refs/heads/master/R/colo.scale.R')</span></span>
<span><span class="co"># par(mfrow = c(1, 2), mar=c(0,0,0,0)) plot(sdm$spacemean, mar = c(0,</span></span>
<span><span class="co"># 0, 0, 0)) plot(st_geometry(region), add = TRUE) rat &lt;-</span></span>
<span><span class="co"># params$effort$nobs / params$effort$nbackground rat &lt;- ifelse(rat ==</span></span>
<span><span class="co"># 0, NA, rat) plot(st_geometry(params$dmesh), border = NA, col =</span></span>
<span><span class="co"># colo.scale(rat, c('gold', 'forestgreen')))</span></span>
<span><span class="co"># plot(st_geometry(region), add = TRUE)</span></span>
<span></span>
<span></span>
<span><span class="co"># e &lt;- extract(sdm$mean, params$dmesh, fun = mean, na.rm = T)</span></span>
<span><span class="co"># plot(e[, 2], params$effort$nobs / params$effort$nbackground)</span></span>
<span></span>
<span><span class="co"># r2 &lt;- sdm$mean r2 &lt;- exp(sdm$linkmean-sdm$spacemean) plot(c(r1,</span></span>
<span><span class="co"># r2), range = range(global(c(r1, r2), 'range', na.rm = T)), mar =</span></span>
<span><span class="co"># c(0, 0, 0, 7)) plot(r2-r1, col =</span></span>
<span><span class="co"># colo.scale(sort(unique(values(r2-r1)[,1])),</span></span>
<span><span class="co"># c('blue','white','red'), center = TRUE))</span></span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Guillaume Blanchet, François Rousseu.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
